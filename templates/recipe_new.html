{% extends "base.html" %}

{% block title %}Новый рецепт · FoodPlanner{% endblock %}

{% block content %}
<section class="recipe-form">
    <div class="container">
        <div class="recipe-form__card">
            <h1>Создайте новый рецепт</h1>
            <p class="recipe-form__subtitle">
                Опишите блюдо, добавьте фотографии и расскажите шаги, чтобы другие могли повторить результат.
            </p>
            <form method="post" action="{{ url_for('create_recipe') }}" enctype="multipart/form-data" class="recipe-form__form">
                <div class="form-group">
                    <label for="title">Название блюда</label>
                    <input type="text" id="title" name="title" required placeholder="Например, паста с лососем" />
                </div>
                <div class="form-group">
                    <label for="description">Описание</label>
                    <textarea id="description" name="description" rows="4" placeholder="Добавьте короткое описание"></textarea>
                </div>
                <div class="form-group">
                    <label for="cover_image">Обложка рецепта</label>
                    <input type="file" id="cover_image" name="cover_image" accept="image/*" />
                </div>
                {% if available_tags %}
                <div class="form-group">
                    <label>Теги</label>
                    <div class="tag-selector">
                        {% for tag in available_tags %}
                        {% set input_id = "tag-new-" ~ tag.value %}
                        <input type="checkbox" id="{{ input_id }}" name="tags" value="{{ tag.value }}" hidden />
                        <button
                            type="button"
                            class="btn btn--ghost tag-button"
                            data-tag-toggle
                            data-target="{{ input_id }}"
                        >
                            {{ tag.label }}
                        </button>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                <div class="ingredients" id="ingredients-wrapper">
                    <h2>Ингредиенты</h2>
                    <div class="ingredient-row">
                        <div class="form-group">
                            <label>Продукт</label>
                            <input type="text" name="ingredient_names" required placeholder="Название ингредиента" />
                        </div>
                        <div class="form-group">
                            <label>Количество</label>
                            <input type="number" step="0.01" min="0" name="ingredient_amounts" required placeholder="0" />
                        </div>
                    </div>
                </div>
                <button type="button" class="btn btn--ghost" id="add-ingredient-btn">Добавить ингредиент</button>
                <div class="recipe-form__steps" id="steps-wrapper">
                    <div class="recipe-step" data-step-index="1">
                        <div class="form-group">
                            <label>Шаг 1</label>
                            <textarea name="steps" rows="3" required placeholder="Опишите первый шаг"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Фото шага (опционально)</label>
                            <input type="file" name="step_images" accept="image/*" />
                        </div>
                    </div>
                </div>
                <button type="button" class="btn btn--ghost" id="add-step-btn">Добавить ещё шаг</button>
                <button type="submit" class="btn btn--primary btn--full">Сохранить рецепт</button>
            </form>
        </div>
    </div>
</section>
<script>
    const stepsWrapper = document.getElementById("steps-wrapper");
    const addStepBtn = document.getElementById("add-step-btn");
    const ingredientsWrapper = document.getElementById("ingredients-wrapper");
    const addIngredientBtn = document.getElementById("add-ingredient-btn");
    const tagButtons = document.querySelectorAll("[data-tag-toggle]");
    let stepCount = stepsWrapper.children.length;

    addStepBtn?.addEventListener("click", () => {
        stepCount += 1;
        const stepEl = document.createElement("div");
        stepEl.className = "recipe-step";
        stepEl.dataset.stepIndex = String(stepCount);
        stepEl.innerHTML = `
            <div class="form-group">
                <label>Шаг ${stepCount}</label>
                <textarea name="steps" rows="3" required placeholder="Опишите шаг ${stepCount}"></textarea>
            </div>
            <div class="form-group">
                <label>Фото шага (опционально)</label>
                <input type="file" name="step_images" accept="image/*" />
            </div>
        `;
        stepsWrapper.appendChild(stepEl);
    });

    addIngredientBtn?.addEventListener("click", () => {
        const row = document.createElement("div");
        row.className = "ingredient-row";
        row.innerHTML = `
            <div class="form-group">
                <label>Продукт</label>
                <input type="text" name="ingredient_names" required placeholder="Название ингредиента" />
            </div>
            <div class="form-group">
                <label>Количество</label>
                <input type="number" name="ingredient_amounts" step="0.01" min="0" required placeholder="0" />
            </div>
        `;
        ingredientsWrapper.appendChild(row);
    });

    tagButtons.forEach((button) => {
        const inputId = button.getAttribute("data-target");
        const input = document.getElementById(inputId);
        if (!input) {
            return;
        }
        const syncState = () => {
            button.classList.toggle("tag-button--active", input.checked);
        };
        syncState();
        button.addEventListener("click", () => {
            input.checked = !input.checked;
            syncState();
        });
    });
</script>
{% endblock %}
