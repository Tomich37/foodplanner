{% extends "base.html" %}

{% block title %}Рецепты сообщества · FoodPlanner{% endblock %}

{% block content %}
<section class="recipes-list">
    <div class="container">
        <div class="recipes-list__header">
            <div>
                <h1>Рецепты сообщества</h1>
                <p class="recipes-list__subtitle">
                    Здесь собраны все блюда, которые пользователи уже поделились в FoodPlanner.
                    Добавляйте свои идеи и сохраняйте понравившиеся рецепты.
                </p>
            </div>
            {% if current_user %}
            <a href="{{ url_for('recipes_new') }}" class="btn btn--primary">Создать рецепт</a>
            {% endif %}
        </div>
        <div class="recipes-filters">
            <form
                class="recipes-search"
                method="get"
                data-recipes-search
                data-search-url="{{ url_for('recipes_search') }}"
            >
                <input
                    id="recipes-search-input"
                    type="search"
                    name="q"
                    placeholder="Поиск по названию или ингредиентам"
                    value="{{ search_query or '' }}"
                    aria-label="Поиск по названию или ингредиентам"
                />
                {% for tag in selected_tags %}
                <input type="hidden" name="tags" value="{{ tag }}" />
                {% endfor %}
                <div class="recipes-search__actions">
                    <button type="submit" class="btn btn--primary btn--small">Искать</button>
                    {% if search_query %}
                    <button type="button" class="btn btn--ghost btn--small" data-clear-search>Сбросить поиск</button>
                    {% endif %}
                </div>
            </form>
            {% if available_tags %}
            <div class="recipes-filters__tags">
                <div class="tag-selector">
                    {% for tag in available_tags %}
                    <button
                        type="button"
                        class="btn btn--ghost tag-button {% if selected_tags and tag.value in selected_tags %}tag-button--active{% endif %}"
                        data-filter-tag="{{ tag.value }}"
                    >
                        {{ tag.label }}
                    </button>
                    {% endfor %}
                </div>
                {% if selected_tags %}
                <button type="button" class="btn btn--ghost" data-reset-tags>Сбросить теги</button>
                {% endif %}
            </div>
            {% endif %}
        </div>
        <div class="recipes-results" data-recipes-results>
            {% include "partials/recipes_grid.html" %}
        </div>
    </div>
</section>
<script>
    const filterButtons = document.querySelectorAll("[data-filter-tag]");
    const resetBtn = document.querySelector("[data-reset-tags]");
    const clearSearchBtn = document.querySelector("[data-clear-search]");
    const searchInput = document.getElementById("recipes-search-input");
    const searchForm = document.querySelector("[data-recipes-search]");
    const resultsContainer = document.querySelector("[data-recipes-results]");
    const searchUrl = searchForm?.dataset.searchUrl || "";
    let searchController;
    const buildTarget = (params) => {
        const query = params.toString();
        const basePath = window.location.pathname;
        return query ? `${basePath}?${query}` : basePath;
    };
    const updateHistory = (params) => {
        const target = buildTarget(params);
        window.history?.replaceState?.({}, "", target);
    };
    const getCurrentTags = () => {
        const params = new URLSearchParams(window.location.search);
        return new Set(params.getAll("tags"));
    };
    const applySelection = (tagsSet) => {
        const params = new URLSearchParams(window.location.search);
        params.delete("tags");
        tagsSet.forEach((value) => params.append("tags", value));
        window.location.href = buildTarget(params);
    };
    const debounce = (fn, delay = 250) => {
        let timeout;
        return (...args) => {
            clearTimeout(timeout);
            timeout = setTimeout(() => fn(...args), delay);
        };
    };
    const buildSearchParams = () => {
        const params = new URLSearchParams();
        getCurrentTags().forEach((value) => params.append("tags", value));
        return params;
    };
    const requestSearch = async () => {
        if (!resultsContainer || !searchUrl) {
            return;
        }
        const params = buildSearchParams();
        const query = (searchInput?.value || "").trim();
        if (query) {
            params.set("q", query);
        }
        updateHistory(params);
        const requestUrl = params.toString() ? `${searchUrl}?${params}` : searchUrl;
        searchController?.abort();
        searchController = new AbortController();
        try {
            const response = await fetch(requestUrl, {
                headers: { "X-Requested-With": "fetch" },
                signal: searchController.signal,
            });
            if (!response.ok) {
                return;
            }
            const data = await response.json();
            resultsContainer.innerHTML = data.html || "";
        } catch (error) {
            if (error.name !== "AbortError") {
                console.error("Ошибка поиска рецептов", error);
            }
        }
    };
    const debouncedSearch = debounce(requestSearch, 250);
    filterButtons.forEach((button) => {
        button.addEventListener("click", () => {
            const value = button.getAttribute("data-filter-tag");
            const tagsSet = getCurrentTags();
            if (tagsSet.has(value)) {
                tagsSet.delete(value);
            } else {
                tagsSet.add(value);
            }
            applySelection(tagsSet);
        });
    });
    resetBtn?.addEventListener("click", () => {
        const params = new URLSearchParams(window.location.search);
        params.delete("tags");
        window.location.href = buildTarget(params);
    });
    clearSearchBtn?.addEventListener("click", () => {
        const params = buildSearchParams();
        updateHistory(params);
        if (searchInput) {
            searchInput.value = "";
        }
        debouncedSearch();
    });
    searchForm?.addEventListener("submit", (event) => {
        if (!searchInput) return;
        event.preventDefault();
        searchInput.value = searchInput.value.trim();
        requestSearch();
    });
    searchInput?.addEventListener("input", () => {
        debouncedSearch();
    });
</script>
{% endblock %}
