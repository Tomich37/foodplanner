{% extends "base.html" %}

{% block title %}Новый рецепт · FoodPlanner{% endblock %}

{% block content %}
<section class="recipe-form">
    <div class="container">
        <div class="recipe-form__card">
            <div class="recipe-form__nav">
                <a href="{{ previous_url }}" class="btn btn--ghost btn--small">← Назад</a>
            </div>
            <h1>Создайте новый рецепт</h1>
            <p class="recipe-form__subtitle">
                Опишите блюдо, добавьте фотографии и расскажите шаги, чтобы другие могли повторить результат.
            </p>
            <form method="post" action="{{ url_for('create_recipe') }}" enctype="multipart/form-data" class="recipe-form__form">
                {{ csrf_input(request) }}
                <div class="form-group">
                    <label for="title">Название блюда</label>
                    <input type="text" id="title" name="title" required placeholder="Например, паста с лососем" />
                </div>
                <div class="form-group">
                    <label for="description">Описание</label>
                    <textarea id="description" name="description" rows="4" placeholder="Добавьте короткое описание"></textarea>
                </div>
                <div class="form-group">
                    <label for="cover_image">Обложка рецепта</label>
                    <input type="file" id="cover_image" name="cover_image" accept="image/*" />
                </div>
                {% set selected_tags = selected_tags or [] %}
                {% if primary_tags or extra_tags %}
                <div class="form-group recipe-form__tags-group">
                    <label>Теги</label>
                    <div class="recipe-form__tags-inline">
                        {% if primary_tags %}
                        <div class="recipe-form__tags-buttons">
                            {% for tag in primary_tags %}
                            {% set input_id = "tag-new-" ~ tag.value %}
                            <input
                                type="checkbox"
                                id="{{ input_id }}"
                                name="tags"
                                value="{{ tag.value }}"
                                {% if tag.value in selected_tags %}checked{% endif %}
                                hidden
                            />
                            <button
                                type="button"
                                class="btn btn--ghost tag-button"
                                data-tag-toggle
                                data-target="{{ input_id }}"
                            >
                                {{ tag.label }}
                            </button>
                            {% endfor %}
                        </div>
                        {% endif %}
                        {% if extra_tags %}
                        <div class="recipe-form__tags-extra" data-tag-dropdown>
                            <button
                                type="button"
                                class="btn btn--ghost tag-button recipe-form__tags-extra-toggle {% if selected_extra_tags %}tag-button--active{% endif %}"
                                data-tag-dropdown-toggle
                                aria-expanded="false"
                                aria-haspopup="true"
                            >
                                <span>Дополнительные теги</span>
                                <span class="recipe-form__tags-extra-count" data-tag-dropdown-count>
                                    {% if selected_extra_tags %}({{ selected_extra_tags | length }}){% endif %}
                                </span>
                                <span class="recipe-form__tags-extra-arrow" aria-hidden="true">&#9662;</span>
                            </button>
                            <div class="recipe-form__tags-extra-panel" data-tag-dropdown-panel>
                                <p class="recipe-form__tags-hint">
                                    Отметьте дополнительные теги. Изменения сохранятся автоматически.
                                </p>
                                <div class="recipe-form__tags-extra-list">
                                    {% for tag in extra_tags %}
                                    <label class="recipe-form__tags-option">
                                        <input
                                            type="checkbox"
                                            name="tags"
                                            value="{{ tag.value }}"
                                            {% if tag.value in selected_tags %}checked{% endif %}
                                            data-tag-dropdown-checkbox
                                        />
                                        <span>{{ tag.label }}</span>
                                    </label>
                                    {% endfor %}
                                </div>
                                <button
                                    type="button"
                                    class="btn btn--ghost btn--small recipe-form__tags-extra-close"
                                    data-tag-dropdown-close
                                >
                                    Готово
                                </button>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                <div class="ingredients" id="ingredients-wrapper">
                    <h2>Ингредиенты</h2>
                    <div class="ingredient-row">
                        <div class="form-group">
                            <label>Продукт</label>
                            <div class="autocomplete">
                                <input
                                    type="text"
                                    name="ingredient_names"
                                    class="ingredient-name"
                                    required
                                    placeholder="Название ингредиента"
                                    autocomplete="off"
                                />
                                <div class="autocomplete__list"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Количество</label>
                            <input type="number" step="0.01" min="0" name="ingredient_amounts" required placeholder="0" />
                        </div>
                        <div class="form-group">
                            <label>Ед. изм.</label>
                            <select name="ingredient_units">
                                <option value="g">граммы</option>
                                <option value="ml">миллилитры</option>
                                <option value="tbsp">ст. л.</option>
                                <option value="tsp">ч. л.</option>
                                <option value="pcs">штуки</option>
                                <option value="taste">по вкусу</option>
                            </select>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn btn--ghost" id="add-ingredient-btn">Добавить ингредиент</button>
                <div class="recipe-form__steps" id="steps-wrapper">
                    <div class="recipe-step" data-step-index="1">
                        <div class="form-group">
                            <label>Шаг 1</label>
                            <textarea name="steps" rows="3" required placeholder="Опишите первый шаг"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Фото шага (опционально)</label>
                            <input type="file" name="step_images" accept="image/*" />
                        </div>
                    </div>
                </div>
                <button type="button" class="btn btn--ghost" id="add-step-btn">Добавить ещё шаг</button>
                <button type="submit" class="btn btn--primary btn--full">Сохранить рецепт</button>
            </form>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{{ url_for('static', path='/css/pages/recipe_form.css') }}?v={{ static_version }}" />
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', path='/js/recipe_form.js') }}?v={{ static_version }}" defer></script>
{% endblock %}
