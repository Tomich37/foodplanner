{% extends "base.html" %}

{% block title %}Администрирование · Пользователи{% endblock %}

{% block content %}
{% set admin_list = users | selectattr("is_admin") | list %}
{% set user_list = users | rejectattr("is_admin") | list %}

<section class="admin-users">
    <div class="container">
        <div class="admin-nav">
            <a href="{{ url_for('admin_users') }}" class="admin-nav__link admin-nav__link--active">Пользователи</a>
            <a href="{{ url_for('admin_tags') }}" class="admin-nav__link">Теги</a>
        </div>
        <div class="admin-users__header">
            <div>
                <p class="eyebrow">Управление сообществом</p>
                <h1>Панель пользователей</h1>
                <p class="admin-users__subtitle">
                    Назначайте администраторов, сбрасывайте пароли и блокируйте учетные записи, которые нарушают правила.
                    Блокировка запрещает пользователю публиковать новые рецепты, но не мешает ему пользоваться остальными
                    возможностями сервиса.
                </p>
            </div>
            <div class="admin-users__stats">
                <div class="stat-card">
                    <div class="stat-card__label">Всего пользователей</div>
                    <div class="stat-card__value">{{ users|length }}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card__label">Администраторы</div>
                    <div class="stat-card__value">{{ admin_list|length }}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card__label">Обычные аккаунты</div>
                    <div class="stat-card__value">{{ user_list|length }}</div>
                </div>
            </div>
        </div>

        {% if form_error %}
        <div class="form-error">{{ form_error }}</div>
        {% endif %}

        <div class="admin-users__controls">
            <div class="btn-group">
                <button class="btn btn--ghost btn--small filter-btn filter-btn--active" data-filter="all">Все</button>
                <button class="btn btn--ghost btn--small filter-btn" data-filter="admin">Админы</button>
                <button class="btn btn--ghost btn--small filter-btn" data-filter="user">Пользователи</button>
            </div>
            <div class="search-box">
                <input type="search" id="user-search" placeholder="Поиск по имени или e-mail" />
            </div>
        </div>

        <div class="admin-users__grid" id="user-grid">
            {% for user in users %}
            <article
                class="user-card"
                data-role="{{ 'admin' if user.is_admin else 'user' }}"
                data-search="{{ (user.full_name or '') | lower }} {{ user.email | lower }}"
            >
                <div class="user-card__top">
                    <div class="user-card__avatar">
                        {{ (user.full_name or user.email)[0]|upper }}
                    </div>
                    <div class="user-card__info">
                        <div class="user-card__name">{{ user.full_name or user.email }}</div>
                        <div class="user-card__email">{{ user.email }}</div>
                        <div class="user-card__meta">
                            ID {{ user.id }} · зарегистрирован:
                            {{ user.created_at.strftime('%d.%m.%Y') if user.created_at else '—' }}
                        </div>
                    </div>
                    <div class="user-card__badges">
                        <span class="badge {{ 'badge--success' if user.is_admin else '' }}">
                            {{ 'Администратор' if user.is_admin else 'Пользователь' }}
                        </span>
                        {% if user.is_banned %}
                        <span class="badge badge--danger">Заблокирован</span>
                        {% endif %}
                    </div>
                </div>

                {% if user.is_banned %}
                <p class="user-card__warning">
                    Пользователь заблокирован и не может публиковать новые рецепты.
                </p>
                {% endif %}

                <div class="user-card__actions">
                    <div class="user-card__actions-row">
                        <a href="{{ url_for('user_profile', user_id=user.id) }}" class="btn btn--ghost btn--small">
                            Профиль
                        </a>
                        {% if user.is_admin %}
                        <form
                            method="post"
                            action="{{ url_for('admin_revoke', user_id=user.id) }}"
                            onsubmit="return confirm('Снять права администратора?');"
                        >
                            <button
                                type="submit"
                                class="btn btn--ghost btn--danger btn--small"
                                {% if user.id == current_user.id %}disabled title="Нельзя снять права с себя"{% endif %}
                            >
                                Снять права
                            </button>
                        </form>
                        {% else %}
                        <form method="post" action="{{ url_for('admin_grant', user_id=user.id) }}">
                            <button type="submit" class="btn btn--primary btn--small">Назначить админом</button>
                        </form>
                        {% endif %}
                        {% if user.is_banned %}
                        <form method="post" action="{{ url_for('admin_unban', user_id=user.id) }}">
                            <button type="submit" class="btn btn--ghost btn--small">Разблокировать</button>
                        </form>
                        {% else %}
                        <form
                            method="post"
                            action="{{ url_for('admin_ban', user_id=user.id) }}"
                            onsubmit="return confirm('Заблокировать пользователя? Он потеряет возможность создавать рецепты.');"
                        >
                            <button type="submit" class="btn btn--ghost btn--small">Заблокировать</button>
                        </form>
                        {% endif %}
                    </div>
                    <form
                        method="post"
                        action="{{ url_for('admin_user_password', user_id=user.id) }}"
                        class="user-card__password"
                    >
                        <label>
                            <span>Новый пароль</span>
                            <input
                                type="password"
                                name="new_password"
                                minlength="6"
                                required
                                placeholder="Не менее 6 символов"
                            />
                        </label>
                        <button type="submit" class="btn btn--primary btn--small">Сменить</button>
                    </form>
                </div>
            </article>
            {% endfor %}
        </div>
    </div>
</section>

{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{{ url_for('static', path='/css/pages/admin_users.css') }}?v={{ static_version }}" />
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', path='/js/admin_users.js') }}?v={{ static_version }}" defer></script>
{% endblock %}
