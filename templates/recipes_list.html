{% extends "base.html" %}

{% block title %}Рецепты сообщества · FoodPlanner{% endblock %}

{% block content %}
<section class="recipes-list">
    <div class="container">
        <div class="recipes-list__header">
            <div>
                <h1>Рецепты сообщества</h1>
                <p class="recipes-list__subtitle">
                    Здесь собраны все блюда, которые пользователи уже поделились в FoodPlanner.
                    Добавляйте свои идеи и сохраняйте понравившиеся рецепты.
                </p>
            </div>
            {% if current_user %}
            <a href="{{ url_for('recipes_new') }}" class="btn btn--primary">Создать рецепт</a>
            {% endif %}
        </div>
        {% if available_tags %}
        <div class="recipes-filters">
            <div class="tag-selector">
                {% for tag in available_tags %}
                <button
                    type="button"
                    class="btn btn--ghost tag-button {% if selected_tags and tag.value in selected_tags %}tag-button--active{% endif %}"
                    data-filter-tag="{{ tag.value }}"
                >
                    {{ tag.label }}
                </button>
                {% endfor %}
            </div>
            {% if selected_tags %}
            <button type="button" class="btn btn--ghost" data-reset-tags>Сбросить</button>
            {% endif %}
        </div>
        {% endif %}
        {% if recipes %}
        <div class="recipes-grid">
            {% for recipe in recipes %}
            <article class="recipe-card">
                <img src="{{ cover_url(recipe) }}" alt="{{ recipe.title }}" class="recipe-card__image" />
                <div class="recipe-card__body">
                    <div class="recipe-card__top">
                        <h3 class="recipe-card__title">{{ recipe.title }}</h3>
                        <span class="badge">
                            {{ recipe.author.full_name or recipe.author.email }}
                        </span>
                    </div>
                    {% if recipe.description %}
                    <p class="recipe-card__description">
                        {{ recipe.description }}
                    </p>
                    {% endif %}
                    {% if recipe.tags %}
                    <div class="recipe-card__tags">
                        {% for tag in recipe.tags %}
                        <span class="badge badge--tag">
                            {{ tag_labels.get(tag, tag) if tag_labels else tag }}
                        </span>
                        {% endfor %}
                    </div>
                    {% endif %}
                    <div class="recipe-card__meta">
                        <span>Шагов: {{ recipe.steps | length }}</span>
                        <span>Ингредиентов: {{ recipe.ingredients | length }}</span>
                    </div>
                    <div class="recipe-card__actions">
                        <a
                            href="{{ url_for('recipe_detail', recipe_id=recipe.id) }}"
                            class="btn btn--small btn--primary"
                            >Открыть</a
                        >
                        {% if current_user and (recipe.user_id == current_user.id or current_user.is_admin) %}
                        <a
                            href="{{ url_for('recipes_edit', recipe_id=recipe.id) }}"
                            class="btn btn--small btn--ghost"
                            >Редактировать</a
                        >
                        {% endif %}
                    </div>
                </div>
            </article>
            {% endfor %}
        </div>
        {% else %}
        <p class="recipes-list__empty">
            Пока ещё нет рецептов, но вы можете стать первым автором!
        </p>
        {% endif %}
    </div>
</section>
<script>
    const filterButtons = document.querySelectorAll("[data-filter-tag]");
    const resetBtn = document.querySelector("[data-reset-tags]");
    const getCurrentTags = () => {
        const params = new URLSearchParams(window.location.search);
        return new Set(params.getAll("tags"));
    };
    const applySelection = (tagsSet) => {
        const params = new URLSearchParams(window.location.search);
        params.delete("tags");
        tagsSet.forEach((value) => params.append("tags", value));
        const newSearch = params.toString();
        const basePath = window.location.pathname;
        const target = newSearch ? `${basePath}?${newSearch}` : basePath;
        window.location.href = target;
    };
    filterButtons.forEach((button) => {
        button.addEventListener("click", () => {
            const value = button.getAttribute("data-filter-tag");
            const tagsSet = getCurrentTags();
            if (tagsSet.has(value)) {
                tagsSet.delete(value);
            } else {
                tagsSet.add(value);
            }
            applySelection(tagsSet);
        });
    });
    resetBtn?.addEventListener("click", () => {
        window.location.href = window.location.pathname;
    });
</script>
{% endblock %}
