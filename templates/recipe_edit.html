{% extends "base.html" %}

{% block title %}Редактировать рецепт · FoodPlanner{% endblock %}

{% block content %}
<section class="recipe-form">
    <div class="container">
        <div class="recipe-form__card">
            <h1>Редактировать рецепт</h1>
            <p class="recipe-form__subtitle">
                Измените описание, замените изображения или обновите ингредиенты и шаги.
            </p>
            <form
                method="post"
                action="{{ url_for('update_recipe', recipe_id=recipe.id) }}"
                enctype="multipart/form-data"
                class="recipe-form__form"
            >
                <div class="form-group">
                    <label for="title">Название блюда</label>
                    <input
                        type="text"
                        id="title"
                        name="title"
                        required
                        value="{{ recipe.title }}"
                    />
                </div>
                <div class="form-group">
                    <label for="description">Описание</label>
                    <textarea
                        id="description"
                        name="description"
                        rows="4"
                        placeholder="Коротко расскажите о блюде"
                    >{{ recipe.description or '' }}</textarea>
                </div>
                <div class="form-group">
                    <label for="cover_image">Обложка рецепта</label>
                    <img src="{{ cover_url(recipe) }}" alt="Обложка" class="recipe-step__preview" />
                    <input type="file" id="cover_image" name="cover_image" accept="image/*" />
                    <small class="form-hint">Оставьте поле пустым, чтобы сохранить текущее изображение.</small>
                </div>
                {% if available_tags %}
                {% set selected_tags = recipe.tags or [] %}
                <div class="form-group">
                    <label>Теги</label>
                    <div class="tag-selector">
                        {% for tag in available_tags %}
                        {% set input_id = "tag-edit-" ~ loop.index %}
                        <input
                            type="checkbox"
                            id="{{ input_id }}"
                            name="tags"
                            value="{{ tag.value }}"
                            {% if tag.value in selected_tags %}checked{% endif %}
                            hidden
                        />
                        <button
                            type="button"
                            class="btn btn--ghost tag-button"
                            data-tag-toggle
                            data-target="{{ input_id }}"
                        >
                            {{ tag.label }}
                        </button>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                <div class="ingredients" id="ingredients-wrapper">
                    <h2>Ингредиенты</h2>
                    {% if recipe.ingredients %}
                    {% for ingredient in recipe.ingredients %}
                    <div class="ingredient-row">
                        <div class="form-group">
                            <label>Продукт</label>
                            <div class="autocomplete">
                                <input
                                    type="text"
                                    name="ingredient_names"
                                    class="ingredient-name"
                                    required
                                    value="{{ ingredient.name }}"
                                    autocomplete="off"
                                />
                                <div class="autocomplete__list"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Количество</label>
                            <input
                                type="number"
                                step="0.01"
                                min="0"
                                name="ingredient_amounts"
                                required
                                value="{{ '%.2f' % ingredient.amount }}"
                            />
                        </div>
                        <div class="form-group">
                            <label>Ед. изм.</label>
                            {% set unit = ingredient.unit or 'g' %}
                            <select name="ingredient_units">
                                <option value="g" {% if unit == 'g' %}selected{% endif %}>граммы</option>
                                <option value="ml" {% if unit == 'ml' %}selected{% endif %}>миллилитры</option>
                                <option value="tbsp" {% if unit == 'tbsp' %}selected{% endif %}>ст. л.</option>
                                <option value="tsp" {% if unit == 'tsp' %}selected{% endif %}>ч. л.</option>
                                <option value="taste" {% if unit == 'taste' %}selected{% endif %}>по вкусу</option>
                            </select>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="ingredient-row">
                        <div class="form-group">
                            <label>Продукт</label>
                            <div class="autocomplete">
                                <input type="text" name="ingredient_names" class="ingredient-name" required autocomplete="off" />
                                <div class="autocomplete__list"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Количество</label>
                            <input type="number" step="0.01" min="0" name="ingredient_amounts" required />
                        </div>
                        <div class="form-group">
                            <label>Ед. изм.</label>
                            <select name="ingredient_units">
                                <option value="g">граммы</option>
                                <option value="ml">миллилитры</option>
                                <option value="tbsp">ст. л.</option>
                                <option value="tsp">ч. л.</option>
                                <option value="taste">по вкусу</option>
                            </select>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <button type="button" class="btn btn--ghost" id="add-ingredient-btn">
                    Добавить ингредиент
                </button>
                <div class="recipe-form__steps" id="steps-wrapper">
                    {% if recipe.steps %}
                    {% for step in recipe.steps %}
                    <div class="recipe-step" data-step-index="{{ loop.index }}">
                        <div class="form-group">
                            <label>Шаг {{ loop.index }}</label>
                            <textarea name="steps" rows="3" required>{{ step.instruction }}</textarea>
                        </div>
                        {% if step.image_path %}
                        <img src="{{ step.image_path }}" alt="Шаг {{ loop.index }}" class="recipe-step__preview" />
                        {% endif %}
                        <input type="hidden" name="existing_step_images" value="{{ step.image_path or '' }}" />
                        {% if step.image_path %}
                        <div class="form-group form-group--inline">
                            <label>
                                <input type="checkbox" name="delete_step_images" value="{{ loop.index0 }}" />
                                Удалить фото шага
                            </label>
                        </div>
                        {% endif %}
                        <div class="form-group">
                            <label>Новое фото шага (опционально)</label>
                            <input type="file" name="step_images" accept="image/*" />
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="recipe-step" data-step-index="1">
                        <div class="form-group">
                            <label>Шаг 1</label>
                            <textarea name="steps" rows="3" required></textarea>
                        </div>
                        <input type="hidden" name="existing_step_images" value="" />
                        <div class="form-group">
                            <label>Фото шага (опционально)</label>
                            <input type="file" name="step_images" accept="image/*" />
                        </div>
                    </div>
                    {% endif %}
                </div>
                <button type="button" class="btn btn--ghost" id="add-step-btn">Добавить ещё шаг</button>
                <div class="form-actions">
                    <button type="submit" class="btn btn--primary">Сохранить изменения</button>
                    <button
                        type="button"
                        class="btn btn--ghost"
                        onclick="window.location.href='{{ url_for('recipe_detail', recipe_id=recipe.id) }}'"
                    >
                        Отмена
                    </button>
                </div>
            </form>
        </div>
    </div>
</section>
<script>
    const stepsWrapper = document.getElementById("steps-wrapper");
    const addStepBtn = document.getElementById("add-step-btn");
    const ingredientsWrapper = document.getElementById("ingredients-wrapper");
    const addIngredientBtn = document.getElementById("add-ingredient-btn");
    const tagButtons = document.querySelectorAll("[data-tag-toggle]");
    let stepCount = stepsWrapper.children.length || 0;

    addStepBtn?.addEventListener("click", () => {
        stepCount += 1;
        const stepEl = document.createElement("div");
        stepEl.className = "recipe-step";
        stepEl.dataset.stepIndex = String(stepCount);
        stepEl.innerHTML = `
            <div class="form-group">
                <label>Шаг ${stepCount}</label>
                <textarea name="steps" rows="3" required placeholder="Опишите шаг ${stepCount}"></textarea>
            </div>
            <input type="hidden" name="existing_step_images" value="" />
            <div class="form-group">
                <label>Фото шага (опционально)</label>
                <input type="file" name="step_images" accept="image/*" />
            </div>
        `;
        stepsWrapper.appendChild(stepEl);
    });

    function attachAutocomplete(row) {
        const input = row.querySelector(".ingredient-name");
        const unitSelect = row.querySelector("select[name='ingredient_units']");
        const list = row.querySelector(".autocomplete__list");
        if (!input || !list) return;

        let currentSuggestions = [];

        const renderList = () => {
            list.innerHTML = "";
            if (!currentSuggestions.length) {
                list.style.display = "none";
                input.placeholder = "Название ингредиента";
                return;
            }
            input.placeholder = currentSuggestions[0].name;
            currentSuggestions.forEach((item) => {
                const option = document.createElement("button");
                option.type = "button";
                option.textContent = item.name;
                option.dataset.unit = item.unit;
                option.addEventListener("click", () => applySuggestion(item));
                list.appendChild(option);
            });
            list.style.display = "block";
        };

        const applySuggestion = (item) => {
            input.value = item.name;
            if (unitSelect) {
                unitSelect.value = item.unit || "g";
            }
            list.innerHTML = "";
            list.style.display = "none";
        };

        input.addEventListener("input", async () => {
            const query = input.value.trim();
            if (query.length < 2) {
                currentSuggestions = [];
                renderList();
                return;
            }
            try {
                const resp = await fetch(`/recipes/ingredients?q=${encodeURIComponent(query)}`);
                const data = await resp.json();
                currentSuggestions = data.items || [];
                renderList();
            } catch (e) {
                currentSuggestions = [];
                renderList();
            }
        });

        input.addEventListener("keydown", (e) => {
            if (e.key === "Tab" && currentSuggestions.length) {
                e.preventDefault();
                applySuggestion(currentSuggestions[0]);
            }
        });

        document.addEventListener("click", (e) => {
            if (!row.contains(e.target)) {
                list.innerHTML = "";
                list.style.display = "none";
            }
        });
    }

    document.querySelectorAll(".ingredient-row").forEach(attachAutocomplete);
    addIngredientBtn?.addEventListener("click", () => {
        const row = document.createElement("div");
        row.className = "ingredient-row";
        row.innerHTML = `
            <div class="form-group">
                <label>Продукт</label>
                <div class="autocomplete">
                    <input type="text" name="ingredient_names" class="ingredient-name" required placeholder="Название ингредиента" autocomplete="off" />
                    <div class="autocomplete__list"></div>
                </div>
            </div>
            <div class="form-group">
                <label>Количество</label>
                <input type="number" name="ingredient_amounts" step="0.01" min="0" required placeholder="0" />
            </div>
            <div class="form-group">
                <label>Ед. изм.</label>
                <select name="ingredient_units">
                    <option value="g" selected>граммы</option>
                    <option value="ml">миллилитры</option>
                    <option value="tbsp">ст. л.</option>
                    <option value="tsp">ч. л.</option>
                    <option value="taste">по вкусу</option>
                </select>
            </div>
        `;
        ingredientsWrapper.appendChild(row);
    });

    tagButtons.forEach((button) => {
        const inputId = button.getAttribute("data-target");
        const input = document.getElementById(inputId);
        if (!input) {
            return;
        }
        const syncState = () => {
            button.classList.toggle("tag-button--active", input.checked);
        };
        syncState();
        button.addEventListener("click", () => {
            input.checked = !input.checked;
            syncState();
        });
    });

    function attachAutocomplete(row) {
        const input = row.querySelector(".ingredient-name");
        const unitSelect = row.querySelector("select[name='ingredient_units']");
        const list = row.querySelector(".autocomplete__list");
        if (!input || !list) return;

        let currentSuggestions = [];

        const renderList = () => {
            list.innerHTML = "";
            if (!currentSuggestions.length) {
                list.style.display = "none";
                input.placeholder = "Название ингредиента";
                return;
            }
            input.placeholder = currentSuggestions[0].name;
            currentSuggestions.forEach((item) => {
                const option = document.createElement("button");
                option.type = "button";
                option.textContent = item.name;
                option.dataset.unit = item.unit;
                option.addEventListener("click", () => applySuggestion(item));
                list.appendChild(option);
            });
            list.style.display = "flex";
        };

        const applySuggestion = (item) => {
            input.value = item.name;
            if (unitSelect) {
                unitSelect.value = item.unit || "g";
            }
            list.innerHTML = "";
            list.style.display = "none";
        };

        input.addEventListener("input", async () => {
            const query = input.value.trim();
            if (query.length < 2) {
                currentSuggestions = [];
                renderList();
                return;
            }
            try {
                const resp = await fetch(`/recipes/ingredients?q=${encodeURIComponent(query)}`);
                const data = await resp.json();
                currentSuggestions = data.items || [];
                renderList();
            } catch (e) {
                currentSuggestions = [];
                renderList();
            }
        });

        input.addEventListener("keydown", (e) => {
            if (e.key === "Tab" && currentSuggestions.length) {
                e.preventDefault();
                applySuggestion(currentSuggestions[0]);
            }
        });

        document.addEventListener("click", (e) => {
            if (!row.contains(e.target)) {
                list.innerHTML = "";
                list.style.display = "none";
            }
        });
    }
</script>
{% endblock %}
